---
- name: Asegurar dependencias de sistema
  yum:
    name: [wget, gnupg2, python3-PyMySQL, python3-cryptography]
    state: present

- name: Instalar Repositorio y Servidor MySQL 8.4
  shell: |
    wget -4 -nc https://dev.mysql.com/get/mysql84-community-release-el9-1.noarch.rpm -O /tmp/mysql84.rpm
    rpm -Uvh /tmp/mysql84.rpm || true
    dnf install -y mysql-community-server
  register: install_mysql
  changed_when: "'installing' in install_mysql.stdout"

- name: Configurar my.cnf para CloudStack (Desactivando validación)
  lineinfile:
    dest: /etc/my.cnf
    regexp: "^{{ item.split('=')[0] }}"
    insertafter: '^\[mysqld\]'
    line: "{{ item }}"
  with_items:
    - "skip-name-resolve"
    - "default-time-zone='+00:00'"
    - "innodb_rollback_on_timeout=1"
    - "innodb_lock_wait_timeout=600"
    - "max_connections=350"
    - "log-bin=mysql-bin"
    - "binlog-format='ROW'"
    - "mysql_native_password=ON"
    # Esto evita que MySQL cargue el plugin de validación de contraseñas
    - "disable_password_validation=ON"

- name: Reiniciar MySQL para aplicar cambios
  service:
    name: mysqld
    state: restarted

- name: Resetear y Configurar Usuarios (Flujo 8.4 Correcto)
  shell: |
    TEMP_PW=$(grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}')
    
    mysql --connect-expired-password -u root -p"$TEMP_PW" <<EOF
    -- El primer comando DEBE ser ALTER USER
    ALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY '{{ mysql_root_password }}';
    ALTER USER 'root'@'localhost' PASSWORD EXPIRE NEVER;
    CREATE USER IF NOT EXISTS 'root'@'%' IDENTIFIED WITH caching_sha2_password BY '{{ mysql_root_password }}';
    GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;
    FLUSH PRIVILEGES;
    EOF
  no_log: true
  register: user_setup
  failed_when: false

- name: Verificar acceso final
  shell: mysql -u root -p"{{ mysql_root_password }}" -e "SELECT 1;"
  register: final_check
  changed_when: false

- name: Abrir Firewall
  firewalld:
    port: 3306/tcp
    permanent: yes
    state: enabled
    immediate: yes
  ignore_errors: true