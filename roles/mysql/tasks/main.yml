---
- name: Asegurar que wget y GnuPG estén instalados
  yum:
    name: 
      - wget
      - gnupg2
    state: present

- name: Descargar repositorio MySQL usando wget -4
  command: wget -4 https://dev.mysql.com/get/mysql84-community-release-el9-1.noarch.rpm -O /tmp/mysql84-community-release.rpm
  args:
    creates: /tmp/mysql84-community-release.rpm

- name: Instalar repositorio MySQL usando comando RPM directo
  shell: rpm -Uvh /tmp/mysql84-community-release.rpm
  register: rpm_result
  failed_when: 
    - rpm_result.rc != 0 
    - "'ya está instalado' not in rpm_result.stderr"
  changed_when: "'installing' in rpm_result.stdout or 'Preparando' in rpm_result.stdout"

- name: Importar llave GPG oficial de MySQL (Corrección para EL9)
  rpm_key:
    state: present
    key: https://repo.mysql.com/RPM-GPG-KEY-mysql-2025

- name: Forzar IPv4 en la configuración de DNF
  lineinfile:
    path: /etc/dnf/dnf.conf
    line: "ip_resolve=4"
    state: present

- name: Instalar servidor MySQL y conectores
  dnf:
    name: 
      - mysql-community-server
      - mysql-community-client
      - mysql-community-libs
      - mysql-community-common
      - mysql-community-icu-data-files
    state: present
    update_cache: yes
    disable_gpg_check: yes

- name: Instalar dependencias de Python para MySQL
  yum:
    name: 
      - python3-PyMySQL
      - python3-cryptography
    state: present

- name: Configurar parámetros específicos de CloudStack en my.cnf
  lineinfile:
    dest: /etc/my.cnf
    regexp: "^{{ item.split('=')[0] }}"
    insertafter: '^\[mysqld\]'
    line: "{{ item }}"
  with_items:
    - "skip-name-resolve"
    - "default-time-zone='+00:00'"
    - "innodb_rollback_on_timeout=1"
    - "innodb_lock_wait_timeout=600"
    - "max_connections=350"
    - "log-bin=mysql-bin"
    - "binlog-format='ROW'"
    - "mysql_native_password=ON"

- name: Asegurar que el servicio MySQL esté iniciado y habilitado
  service:
    name: mysqld
    state: started
    enabled: yes

# --- SECCIÓN CRÍTICA DE CONTRASEÑAS ---

- name: Obtener la contraseña temporal del log
  shell: grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}'
  register: mysql_temp_password
  changed_when: false
  failed_when: false

- name: Cambiar contraseña temporal por la definitiva de Ansible
  shell: |
    mysql --connect-expired-password -u root -p"{{ mysql_temp_password.stdout }}" --execute="ALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY '{{ mysql_root_password }}';" && \
    mysql -u root -p"{{ mysql_root_password }}" -e "FLUSH PRIVILEGES;"
  register: change_pw
  failed_when: false
  when: mysql_temp_password.stdout != ""
  no_log: true

- name: Crear archivo .my.cnf para permitir acceso root sin password en el shell
  copy:
    dest: /root/.my.cnf
    content: |
      [client]
      user=root
      password="{{ mysql_root_password }}"
      socket=/var/lib/mysql/mysql.sock
    mode: '0600'

- name: Configurar privilegios remotos para CloudStack (root@%)
  shell: |
    mysql -e "CREATE USER IF NOT EXISTS 'root'@'%' IDENTIFIED WITH caching_sha2_password BY '{{ mysql_root_password }}';"
    mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;"
    mysql -e "FLUSH PRIVILEGES;"
  register: remote_privs
  changed_when: remote_privs.rc == 0

- name: Abrir puerto 3306 en Firewalld
  firewalld:
    port: 3306/tcp
    permanent: yes
    state: enabled
    immediate: yes
  ignore_errors: true