---
# roles/parchado/tasks/main.yml
- name: Update package cache (Rocky Linux)
  ansible.builtin.dnf:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_distribution == "Rocky"

- name: Upgrade all packages (Rocky Linux)
  ansible.builtin.dnf:
    name: "*"
    state: latest
  register: upgrade_result
  when: ansible_distribution == "Rocky"

- name: Check if reboot is required (uses needs-restarting if available)
  ansible.builtin.command: needs-restarting -r
  register: needs_restarting
  failed_when: false
  changed_when: false
  when: ansible_distribution == "Rocky"

- name: Reboot if kernel/packages require it
  ansible.builtin.reboot:
    msg: "Rebooting after package upgrade"
    reboot_timeout: 600
  when:
    - ansible_distribution == "Rocky"
    - needs_restarting.rc == 1